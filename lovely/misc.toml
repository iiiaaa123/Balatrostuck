
[manifest]
version = "1.0.0"
dump_lua = true
priority = 0





#Debuff functionality
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
if self.ability.perishable and self.ability.perish_tally <= 0 then 
    if not self.debuff then
        self.debuff = true
        if self.area == G.jokers then self:remove_from_deck(true) end
    end
    return
end
'''
position = "after"
payload = '''
if next(find_joker("Commander Vantas")) and self.ability.name == "Wild Card" then should_debuff = false end
'''
match_indent = true

#Negative bonus chips UI
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) > 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
'''
position = "at"
payload = '''
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) ~= 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
'''
match_indent = true


# Pack Size Bonus
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "local _size = self.ability.extra"
position = "at"
match_indent = true
payload = '''
local _size = self.ability.extra + G.GAME.BALATROSTUCK.pack_size_bonus
'''

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "if G.pack_cards and G.pack_cards.VT.y < G.ROOM.T.h then"
position = "before"
match_indent = true
payload = '''
G.pack_cards.config.real_card_limit = math.min(G.GAME.pack_choices  + G.GAME.BALATROSTUCK.pack_size_bonus,5)
'''




[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'if (id > 0 and rank and rank.face) or next(find_joker("Pareidolia")) then'
position = "before"
payload = '''
if id == 8 and next(find_joker("Snowman")) then
    return true
end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'function Card:set_debuff(should_debuff)'
position = "after"
payload = '''
if next(find_joker("Commander Vantas")) and self.playing_card then
    local hasWild = false
    for k, v in pairs(G.playing_cards) do
        if v.config.center == G.P_CENTERS.m_wild then 
            hasWild = true
            break
        end
    end
    if hasWild then should_debuff = false end
end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'function Card:is_suit(suit, bypass_debuff, flush_calc)'
position = "after"
payload = '''
if next(find_joker("Innapropriate Bucket")) then
    if (self.base.suit == G.GAME.BALATROSTUCK.bucket_suits[1] and suit == G.GAME.BALATROSTUCK.bucket_suits[2]) or (suit == G.GAME.BALATROSTUCK.bucket_suits[1] and self.base.suit == G.GAME.BALATROSTUCK.bucket_suits[2]) then
        return true
    end
end
'''
match_indent = true
times = 1


# Info Queue Fix for Todo List
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''elseif self.ability.name == 'To Do List' then loc_vars = {self.ability.extra.dollars, localize(self.ability.to_do_poker_hand, 'poker_hands')}'''
position = "at"
payload = '''
elseif self.ability.name == 'To Do List' then loc_vars = {self.ability.extra.dollars, localize(self.ability.to_do_poker_hand or 'High Card', 'poker_hands')}
'''
match_indent = true
times = 1

        
## Biscuits
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "function Card:start_dissolve(dissolve_colours, silent, dissolve_time_fac, no_juice)"
position = "after"
payload = '''
if self.edition and self.edition.key == 'e_bstuck_paradox' and next(SMODS.find_card('j_bstuck_biscuits')) then
    self.getting_sliced = nil
    play_sound('bstuck_HomestuckParadoxSaved',0.7,0.7)
    card_eval_status_text(self, 'extra', nil, nil, nil, {message = localize('k_safe_ex')})
    for j=1, #G.jokers.cards do
        local card = G.jokers.cards[j]
        if card.config.center.key == 'j_bstuck_biscuits' then
            card:juice_up()
        end
    end
    return false
end
'''
match_indent = true
times = 1


[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "        self.area.config.type == 'joker' and"
position = "after"
payload = '''
not (self.edition and self.edition.key == 'e_bstuck_paradox' and next(SMODS.find_card('j_bstuck_biscuits'))) and 
'''
match_indent = true
times = 1


## Scratch Tag
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "G.GAME.round_resets.blind_tags.Big = get_next_tag_key()"
position = "at"
payload = '''
G.GAME.round_resets.blind_tags.Big = get_next_tag_key(nil,true)
'''
match_indent = true
times = 1


[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "function get_next_tag_key(append)"
position = "at"
payload = '''
function get_next_tag_key(append,Scratch)
'''
match_indent = true
times = 1


[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "return _tag"
position = "before"
payload = '''
if _tag == 'tag_bstuck_scratch' and not Scratch then
    _tag = 'tag_handy' 
end
'''
match_indent = true
times = 1


