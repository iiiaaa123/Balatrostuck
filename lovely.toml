
[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# # setup for Zodiac/Aspect calculations hook
# [[patches]]
# [patches.pattern]
# target = 'functions/state_events.lua'
# # not sure yet so leaving this empty
# pattern = '' 
# # again not sure so leaving this empty
# payload = '''

# '''
# position = 'after'
# match_indent = true
# overwrite = false

# Mind functionality setup

[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = 'local hand_space = e or math.min(#G.deck.cards, G.hand.config.card_limit - #G.hand.cards)'
payload = '''
if G.GAME.BALATROSTUCK.current_aspect == 'Mind' and (G.GAME.current_round.hands_played > 0 or
G.GAME.current_round.discards_used > 0) then
    hand_space = math.min(#G.deck.cards, G.GAME.BALATROSTUCK.aspect_levels['Mind']+3) 
end
'''
position = 'after'
match_indent = true
overwrite = false

#Debuff functionality
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
if self.ability.perishable and self.ability.perish_tally <= 0 then 
    if not self.debuff then
        self.debuff = true
        if self.area == G.jokers then self:remove_from_deck(true) end
    end
    return
end
'''
position = "after"
payload = '''
if next(find_joker("Commander Vantas")) and self.ability.name == "Wild Card" then should_debuff = false end
'''
match_indent = true

#Negative bonus chips UI
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) > 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
'''
position = "at"
payload = '''
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) ~= 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
'''
match_indent = true


# final_scoring_step support for jokers
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "local nu_chip, nu_mult = G.GAME.selected_back:trigger_effect{context = 'final_scoring_step', chips = hand_chips, mult = mult}"
position = "after"
payload = '''
for j = 1, #G.jokers.cards do
    local tempTable = G.jokers.cards[j]:calculate_joker({final_scoring_step = true})
    if tempTable ~= nil then
        nu_chip = tempTable[1] or nu_chip
        nu_mult = tempTable[2] or u_mult
    end
end

-- THIS IS STUPID
for j = 1, #G.jokers.cards do
    local tempTable = G.jokers.cards[j]:calculate_joker({ace_dick = true})
    if tempTable ~= nil then
        nu_chip = tempTable[1] or nu_chip
        nu_mult = tempTable[2] or u_mult
    end
end
'''
match_indent = true
times = 1

# Slabs and Castes
[[patches]]
[patches.regex]
target = "game.lua"
pattern = "(?<indent>[\t ]*)self.P_TAGS = \\{"
position = "before"
line_prepend = '$indent'
payload = '''
self.P_SLABS = {}
self.P_CASTES = {}
'''

[[patches]]
[patches.regex]
target = "game.lua"
pattern = "(?<indent>[\t ]*)self.P_CENTER_POOLS = \\{\\n"
position = "after"
line_prepend = '$indent$indent'
payload = '''
Slabs = {},
Castes = {},
'''

[[patches]]
[patches.regex]
target = "game.lua"
pattern = "(?<indent>[\t ]*)G\\.GAME\\.tags = \\{\\}\\n"
position = "after"
line_prepend = '$indent'
payload = '''
G.GAME.slab = nil
'''

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "table.insert(cards, G.hand.highlighted[i])"
position = "before"
match_indent = true
payload = '''
if G.GAME.slab ~= nil then
    local eval = nil
    eval = G.GAME.slab:apply_to_run({discard = true, other_card = G.hand.highlighted[i], full_hand = G.hand.highlighted})
end
'''
times = 1

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "inc_career_stat('c_cards_discarded', highlighted_count)"
position = "after"
match_indent = true
payload = '''
if G.GAME.slab ~= nil then
    local slab_eval = nil
    slab_eval = G.GAME.slab:apply_to_run({pre_discard = true, full_hand = G.hand.highlighted, hook = hook})
end
'''
times = 1

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "if G.GAME.round_resets.ante == G.GAME.win_ante and G.GAME.blind:get_type() == 'Boss' then"
position = "before"
match_indent = true
payload = '''
if G.GAME.slab ~= nil then
    local slab_eval = nil
    slab_eval = G.GAME.slab:apply_to_run({end_of_round = true, game_over = game_over})
end
'''
times = 1


[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "local effects = {eval_card(G.hand.cards[i], {cardarea = G.hand, full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands})}"
position = "after"
match_indent = true
payload = '''
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local caste_eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run({cardarea = G.hand, full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands, other_card = G.hand.cards[i], individual = true})
        if caste_eval then
            table.insert(effects, caste_eval)
        end
    end
end
'''

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "local effects = {eval_card(scoring_hand[i], {cardarea = G.play, full_hand = G.play.cards, scoring_hand = scoring_hand, poker_hand = text})}"
position = "after"
match_indent = true
payload = '''
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local caste_eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run({cardarea = G.play, full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands, other_card = scoring_hand[i], individual = true})
        if caste_eval then
            table.insert(effects, caste_eval)
        end
    end
end
'''


[[patches]]
[patches.regex]
target = "functions/state_events.lua"
pattern = '''(?<indent>[\t ]*)                --From jokers'''
position = "before"
line_prepend = '$indent'
payload = '''
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run({cardarea = G.play, full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands, other_card = scoring_hand[i], repetition = true})
        for h = 1, eval.repetitions do
            reps[#reps+1] = eval
        end
    end
end
'''
times = 1


[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "G.GAME.blind:set_blind(G.GAME.round_resets.blind)"
position = "after"
match_indent = true
payload = '''
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local caste_eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run({setting_blind = true, blind = G.GAME.round_resets.blind})
    end
end'''

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "local removed = false"
position = "after"
match_indent = true
payload = '''
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local caste_eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run({discard = true, other_card =  G.hand.highlighted[i], full_hand = G.hand.highlighted})
        if caste_eval then
            if caste_eval.remove then remove = true end
        end
    end
end'''



[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "card_eval_status_text((reps[j].jokers or reps[j].seals).card, 'jokers', nil, nil, nil, (reps[j].jokers or reps[j].seals))"
position = "at"
match_indent = true
payload = '''
card_eval_status_text((reps[j].jokers or reps[j].seals or reps[j]).card, 'jokers', nil, nil, nil, (reps[j].jokers or reps[j].seals or reps[j]))
'''

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "G.GAME.blind:set_blind(G.GAME.round_resets.blind)"
position = "after"
match_indent = true
payload = '''
if G.GAME.slab ~= nil then
    local slab_eval = nil
    slab_eval = G.GAME.slab:apply_to_run({start_of_round = true})
end
'''

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "G.GAME.spectral_rate = G.GAME.spectral_rate or 0"
position = "after"
payload = '''
local forced_joker = nil
for j = 1, #G.jokers.cards do
    if not forced_joker then
        forced_joker = G.jokers.cards[j]:calculate_joker({store_joker_create = true, shop_card = card, debugstring = 'Apple'})
    if forced_joker then
        for j = 1, #G.jokers.cards do
            if G.jokers.cards[j]:calculate_joker({store_joker_modify = true, shop_card = forced_joker, debugstring = 'Cherry'}) then break end
        end
        return forced_joker end
    end
end
'''
match_indent = true
times = 1

[[patches]]
[patches.regex]
target = "functions/UI_definitions.lua"
pattern = '''(?<indent>[\t ]*)                    for k, v in ipairs\(G\.GAME\.tags\) do'''
position = "before"
line_prepend = '$indent'
payload = '''
for j = 1, #G.jokers.cards do
    if G.jokers.cards[j]:calculate_joker({store_joker_modify = true, shop_card = card, debugstring = 'Banana'}) then break end
end
'''
times = 1

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = "for _kk, vvv in ipairs(G.GAME.tags) do"
position = "before"
payload = '''
for j = 1, #G.jokers.cards do
    if G.jokers.cards[j]:calculate_joker({store_joker_modify = true, shop_card = v, debugstring = 'Kiwi'}) then break end
end
'''
match_indent = true
times = 1


[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'if id == 11 or id == 12 or id == 13 or next(find_joker("Pareidolia")) then'
position = "before"
payload = '''
if id == 8 and next(find_joker("Snowman")) then
    return true
end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'function Card:set_debuff(should_debuff)'
position = "after"
payload = '''
if next(find_joker("Commander Vantas")) and self.playing_card then
    local hasWild = false
    for k, v in pairs(G.playing_cards) do
        if v.config.center == G.P_CENTERS.m_wild then 
            hasWild = true
            break
        end
    end
    if hasWild then should_debuff = false end
end
'''
match_indent = true
times = 1