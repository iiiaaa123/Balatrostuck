
[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# # setup for Zodiac/Aspect calculations hook NOT NEEDED ANYMORE LMAOOOOOO
# [[patches]]
# [patches.pattern]
# target = 'functions/state_events.lua'
# # not sure yet so leaving this empty
# pattern = '' 
# # again not sure so leaving this empty
# payload = '''

# '''
# position = 'after'
# match_indent = true
# overwrite = false



#Debuff functionality
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
if self.ability.perishable and self.ability.perish_tally <= 0 then 
    if not self.debuff then
        self.debuff = true
        if self.area == G.jokers then self:remove_from_deck(true) end
    end
    return
end
'''
position = "after"
payload = '''
if next(find_joker("Commander Vantas")) and self.ability.name == "Wild Card" then should_debuff = false end
'''
match_indent = true

#Negative bonus chips UI
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) > 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
'''
position = "at"
payload = '''
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) ~= 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
'''
match_indent = true


# Context.Ace_Dick
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "hand_chips = mod_chips(nu_chip or hand_chips)"
position = "after"
payload = '''
SMODS.calculate_context({ace_dick = true})
'''
match_indent = true
times = 1

# Slabs and Castes
[[patches]]
[patches.regex]
target = "game.lua"
pattern = "(?<indent>[\t ]*)self.P_TAGS = \\{"
position = "before"
line_prepend = '$indent'
payload = '''
self.P_SLABS = {}
self.P_CASTES = {}
'''


# Slabs and Castes Calculation
[[patches]]
[patches.regex]
target = '=[SMODS _ "src/utils.lua"]'
pattern = "(?<indent>[\t ]*)        SMODS\\.trigger_effects\\(effects, card\\)"
position = "before"
line_prepend = '$indent'
payload = '''
-- Castes
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local caste_eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run(context)
        if caste_eval then 
            table.insert(effects, {jokers = caste_eval}) 
            if caste_eval.retriggers then
                context.retrigger_joker = true
                for rt = 1, #caste_eval.retriggers do
                    table.insert(effects, { caste_eval.retriggers[rt] })
                end
                context.retrigger_joker = nil
            end
        end
    end
end

if G.GAME.slab ~= nil then
    local slab_eval = G.GAME.slab:apply_to_run(context,true)
    if slab_eval then 
        table.insert(effects, {jokers = slab_eval}) 
        if slab_eval.retriggers then
            context.retrigger_joker = true
            for rt = 1, #slab_eval.retriggers do
                table.insert(effects, { slab_eval.retriggers[rt] })
            end
            context.retrigger_joker = nil
        end
    end
end
'''

[[patches]]
[patches.regex]
target = '=[SMODS _ "src/utils.lua"]'
pattern = "context.main_eval = nil"
position = "before"
line_prepend = '$indent'
payload = '''
-- Castes
local effects = {}

if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local caste_eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run(context)
        if caste_eval then 
            table.insert(effects, {jokers = caste_eval}) 
            if caste_eval.retriggers then
                context.retrigger_joker = true
                for rt = 1, #caste_eval.retriggers do
                    table.insert(effects, { caste_eval.retriggers[rt] })
                end
                context.retrigger_joker = nil
            end
        end
    end
end

if G.GAME.slab ~= nil then
    local slab_eval = G.GAME.slab:apply_to_run(context)
    if slab_eval then 
        table.insert(effects, {jokers = slab_eval}) 
        if slab_eval.retriggers then
            context.retrigger_joker = true
            for rt = 1, #slab_eval.retriggers do
                table.insert(effects, { slab_eval.retriggers[rt] })
            end
            context.retrigger_joker = nil
        end
    end
end
SMODS.trigger_effects(effects,card)
'''

[[patches]]
[patches.regex]
target = '=[SMODS _ "src/utils.lua"]'
pattern = "(?<indent>[\t ]*)            effect\\.card = effect\\.card or G\\.deck\\.cards\\[1\\] or G\\.deck\n            reps\\[#reps\\+1\\] = \\{key = effect\\}\n        end\n    end"
position = "after"
line_prepend = '$indent'
payload = '''
if #G.GAME.BALATROSTUCK.active_castes > 0 then
    for c = 1, #G.GAME.BALATROSTUCK.active_castes do
        local eval = G.GAME.BALATROSTUCK.active_castes[c]:apply_to_run(context)
        if eval and eval.repetitions then
            for h=1, eval.repetitions do
                if h == 1 then eval.message = nil end
                eval.card = eval.card or _card
                reps[#reps+1] = {key = eval}
            end
        end
    end
end
'''

[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "for _, _area in ipairs(SMODS.get_card_areas('jokers')) do"
position = "before"
match_indent = true
payload = '''
if G.GAME.slab ~= nil then
    local slab_eval = G.GAME.slab:apply_to_run({full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands, other_joker = _card.ability.set == 'Joker' and _card or false, other_consumeable = _card.config.center.consumeable and _card or false},true)
    if slab_eval then
        table.insert(effects, {joker = slab_eval})
    end
end
'''


[[patches]]
[patches.regex]
target = "game.lua"
pattern = "(?<indent>[\t ]*)self.P_CENTER_POOLS = \\{\\n"
position = "after"
line_prepend = '$indent$indent'
payload = '''
Slabs = {},
Castes = {},
'''

[[patches]]
[patches.regex]
target = "game.lua"
pattern = "(?<indent>[\t ]*)G\\.GAME\\.tags = \\{\\}\\n"
position = "after"
line_prepend = '$indent'
payload = '''
G.GAME.slab = nil
'''


[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "amount = amount or 1"
position = "after"
match_indent = true
payload = '''
if G.GAME.slab ~= nil then
    local eval = nil
    eval = G.GAME.slab:apply_to_run({level_up_hand, amount = amount},true)
    if eval then amount = eval.amount end
end
'''
times = 1



[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "_tag.HUD_tag = G.HUD_tags[#G.HUD_tags]"
position = "after"
match_indent = true
payload = '''
if G.GAME.slab ~= nil and not fromMind then
    local slab_eval = nil
    slab_eval = G.GAME.slab:apply_to_run({tag = _tag})
end
'''

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "function add_tag(_tag)"
position = "at"
match_indent = true
payload = '''
function add_tag(_tag,fromMind)
'''

# Pack Size Bonus
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "local _size = self.ability.extra"
position = "at"
match_indent = true
payload = '''
local _size = self.ability.extra + G.GAME.BALATROSTUCK.pack_size_bonus
'''

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "G.GAME.pack_choices = self.config.center.config.choose or 1"
position = "before"
match_indent = true
payload = '''
G.GAME.pack_size = math.min(G.GAME.pack_size + G.GAME.BALATROSTUCK.pack_size_bonus,5)
'''

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "G.GAME.spectral_rate = G.GAME.spectral_rate or 0"
position = "after"
payload = '''
local forced_joker = nil
for j = 1, #G.jokers.cards do
    if not forced_joker then
        forced_joker = G.jokers.cards[j]:calculate_joker({store_joker_create = true, shop_card = card, debugstring = 'Apple'})
    if forced_joker then
        for j = 1, #G.jokers.cards do
            if G.jokers.cards[j]:calculate_joker({store_joker_modify = true, shop_card = forced_joker, debugstring = 'Cherry'}) then break end
        end
        return forced_joker end
    end
end
'''
match_indent = true
times = 1

[[patches]]
[patches.regex]
target = "functions/UI_definitions.lua"
pattern = '''(?<indent>[\t ]*)                    for k, v in ipairs\(G\.GAME\.tags\) do'''
position = "before"
line_prepend = '$indent'
payload = '''
for j = 1, #G.jokers.cards do
    if G.jokers.cards[j]:calculate_joker({store_joker_modify = true, shop_card = card, debugstring = 'Banana'}) then break end
end
'''
times = 1

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = "for _kk, vvv in ipairs(G.GAME.tags) do"
position = "before"
payload = '''
for j = 1, #G.jokers.cards do
    if G.jokers.cards[j]:calculate_joker({store_joker_modify = true, shop_card = v, debugstring = 'Kiwi'}) then break end
end
'''
match_indent = true
times = 1


[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'if (id > 0 and rank and rank.face) or next(find_joker("Pareidolia")) then'
position = "before"
payload = '''
if id == 8 and next(find_joker("Snowman")) then
    return true
end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'function Card:set_debuff(should_debuff)'
position = "after"
payload = '''
if next(find_joker("Commander Vantas")) and self.playing_card then
    local hasWild = false
    for k, v in pairs(G.playing_cards) do
        if v.config.center == G.P_CENTERS.m_wild then 
            hasWild = true
            break
        end
    end
    if hasWild then should_debuff = false end
end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = 'function Card:is_suit(suit, bypass_debuff, flush_calc)'
position = "after"
payload = '''
if next(find_joker("Innapropriate Bucket")) then
    if (self.base.suit == G.GAME.BALATROSTUCK.bucket_suits[1] and suit == G.GAME.BALATROSTUCK.bucket_suits[2]) or (suit == G.GAME.BALATROSTUCK.bucket_suits[1] and self.base.suit == G.GAME.BALATROSTUCK.bucket_suits[2]) then
        return true
    end
end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = 'joker_max = 2,'
position = "after"
payload = '''
booster_max = 2,
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '''{card_limit = 2, type = 'shop', highlight_limit = 1, card_w = 1.27*G.CARD_W})'''
position = "at"
payload = '''
{card_limit = G.GAME.shop.booster_max, type = 'shop', highlight_limit = 1, card_w = 1.27*G.CARD_W})
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''for i = 1, 2 do'''
position = "at"
payload = '''
for i = 1, G.GAME.shop.booster_max - #G.shop_booster.cards do
'''
match_indent = true
times = 1